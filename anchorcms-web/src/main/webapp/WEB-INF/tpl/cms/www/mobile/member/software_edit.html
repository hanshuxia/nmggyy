<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>软件编辑</title>
    <link rel="shortcut  icon" type="image/x-icon" href="/${res}/resources/images/favicon.ico" media="screen"/>
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/${res}/resources/css/base.css"/>
    <link rel="stylesheet" type="text/css" href="/${res}/resources/css/contact.css"/>
    <link href="/${res}/css/logistics/layer.css" type="text/css" rel="stylesheet">

    <!--[if lte IE 9]>
    <script src="http://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="http://cdn.bootcss.com/html5media/1.1.8/html5media.min.js"></script>
    <script src="http://cdn.bootcss.com/respond.js/1.3.0/respond.min.js"></script>
    <script type="text/javascript" src="/thirdparty/jquery-placeholder/placeholder-ie9.js"></script>
    <![endif]-->

    <link href="${resSys}/jqueryUI/jquery.ui.css" rel="stylesheet" type="text/css"/>
    <script src="${resSys}/jquery.js" type="text/javascript"></script>
    <script src="${resSys}/front.js" type="text/javascript"></script>
    <script src="${base}/thirdparty/ckeditor/ckeditor.js" type="text/javascript"></script>
    <script src="${base}/res/common/js/jquery.ext.js" type="text/javascript"></script>
    <script src="${resSys}/jqueryUI/jquery-ui.js" type="text/javascript"></script>
    <script src="${base}/thirdparty/swfupload/swfupload.js" type="text/javascript"></script>
    <script src="${base}/thirdparty/swfupload/swfupload.queue.js" type="text/javascript"></script>
    <script src="${base}/thirdparty/swfupload/fileprogress.js" type="text/javascript"></script>
    <script src="${base}/thirdparty/swfupload/handlers.js" type="text/javascript"></script>
    <link href="${base}/thirdparty/swfupload/process.css" rel="stylesheet" type="text/css"/>

    <!--日期插件-->
    <script src="${base}/thirdparty/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/${res}/resources/css/releasePower.css"/>

    <!--添加表单校验-->
    <script src="${base}/res/common/js/jquery.validate.js" type="text/javascript"></script>
    <script src="${base}/res/common/js/messages_zh.js" type="text/javascript"></script>
    <!--自己写校验方法-->
    <script type="text/javascript" charset="utf-8" src="/${res}/resources/js/validateCheck.js"></script>
    <script type="text/javascript" src="/${res}/js/logistics/ui.js"></script>
    <script type="text/javascript" src="/${res}/js/logistics/layer.js"></script>

    <!--传文件相关-->
    <script type="text/javascript">
        // 联系人信息是否有默认地址
        window.isDef = 0;

        // 弹出和更新联系人信息界面的ajax
        function getContactAjax(userId){
            $.ajax({
                type:"post",
                url:"/member/getContactList.jspx?userId=" + userId,
                dataType:"json",
                success:function(json){
                    if (json.data.length == 0) { // 没有用户联系信息
                        openContactAdd();
                    } else {
                        // 填充表格信息
                        fillContactTable(json);
                        // 塞入联系人信息
                        fillContactInfo();
                    }
                },
                error:function(){
                    ui.alert("数据传输失败，原因：1、用户未登录，2、用户无关联公司，3、请求的联系信息不存在或未找到");
                }
            })
        }
        //切字符串方法
        function s_cut(s,lenth,append){
            var index = 0;
            var len = 0;
            var str = "";
            var a = "";
            for (var i = 0; len < lenth; i++) {
                index = i;
                a = s.charAt(i);
                str += a;
                if (a.match(/[^\x00-\xff]/ig) != null) {
                    len += 2;
                }
                else {
                    len += 1;
                }
            }
            if(s.charAt(index+1) == ""){
                return str;
            }else{
                return (str+append);
            }
        }



        // 根据json填联系人信息的方法
        function fillContactTable(jsonObj){
            var tBody = $('#bjTable tbody');
            tBody.html("");

            $.each(jsonObj.data, function(i, item){
                tBody.append("<tr id = 'infoSelected' onclick='infoSelected(this)'></tr>");
                var tr = tBody.find('tr:last');
                tr.append("<td id='shipAddressName'><a title='"+item.shipAddressName+"'>"+s_cut(item.shipAddressName,4,'..')+"</a></td>");
                tr.append("<td id='userName1' class='name-li-ckt-info' style='width: 100px'><a title='"+item.userName+"'>"+item.userName+"</a></td>");
                tr.append("<td id='addrProvince1' hidden><a title='"+item.province+"'>"+item.province+"</a></td>");
                tr.append("<td id='addrCity1' hidden><a title='"+item.city+"'>"+item.city+"</a></td>");
                tr.append("<td id='addrCounty1' hidden><a title='"+item.country+"'>"+item.country+"</a></td>");
                tr.append("<td id='addrStreet1' hidden><a title='"+item.address+"'>"+item.address+"</a></td>");
                tr.append("<td id='addr' class='address-li-ckt-info'><a title='"+item.province+item.city+item.country+item.address+"'>"+item.province+item.city+item.country+item.address+"</a></td>");
                tr.append("<td id='fax1' hidden><a title='"+item.fax+"'>"+item.fax+"</a></td>");
                tr.append("<td id='email1' hidden><a title='"+item.email+"'>"+item.email+"</a></td>");
                tr.append("<td id='mobile1'><a title='"+item.mobile+"'>"+item.mobile+"</a></td>");
                tr.append("<td id='postCode1' hidden><a title='"+item.zip+"'>"+item.zip+"</a></td>");
                tr.addClass("li-ckt-info");
                if(item.defAddr == "1") {
                    window.isDef += 1;
                    tr.append("<td id='defAddr' class='default-li-ckt-info'>默认地址</td>");
                } else {
                    tr.append("<td id='defAddr'></td>");
                }
                if((item.province == '${software.addrProvince!}') && (item.city == '${software.addrCity!}') && (item.country == '${software.addrCounty!}') && (item.address == '${software.addrStreet!}')) {
                    $('#bjTable tbody').find('tr:eq(' + i + ')').find("#shipAddressName").addClass("ckt-checkbox selected");
                    $('#bjTable tbody').find('tr:eq(' + i + ')').addClass("infoSelected");
                }
            });
            $('#bjWindow').show();
            if(tBody.children('tr').length == 0){
                openContactAdd();
            }
        }

        //表单验证
        $().ready(function () {
            validform();
            getContactAjax(${user.userId});
        });

        function validform() {
            /*关键在此增加了一个return，返回的是一个validate对象，这个对象有一个form方法，返回的是是否通过验证*/
            return $("#release_form").validate();
        }

        /**获取选中的软件分类 */
        function getSelectTopic() {
            var theSelect = document.getElementById("softwareType");
            for (var i = 0; i < theSelect.options.length; i++) {
                if (theSelect.options[i].value == "${software.softwareType?default('')}") {
                    theSelect.options[i].selected = true;
                    break;
                }
            }
        }

        /**获取选中的付费类型 */
        function getPayType() {
            var theSelect = document.getElementById("payType");
            for (var i = 0; i < theSelect.options.length; i++) {
                if (theSelect.options[i].value == "${software.payType?default('')}") {
                    theSelect.options[i].selected = true;
                    break;
                }
            }
        }

        // 是否平台代理、是否在线应用逻辑
        function setFileComponent() {
            var payType = "${software.payType?default('')}";
            var isAgency = "${software.agencyFlag?default('')}";
            var isOnline = "${software.isOnline?default('')}";
            if ((payType == "付费") || (payType == "租赁")) {
                $('#isAgencyDiv').show();
                if (isAgency == "0") { // 非平台代理
                    $('#isOnlineDiv').hide();
                    $("#softwareSizeDiv").hide();
                    $('#imgUploadDiv2').hide();
                    $('#softwareHrefDiv').show();
                } else if (isAgency == "1") { // 平台代理
                    $('#isOnlineDiv').show();
                    $("#softwareSizeDiv").show();
                    if (isOnline == "1") { // 平台代理非在线应用
                        $('#imgUploadDiv2').show();
                        $('#softwareHrefDiv').hide();
                    } else if (isOnline == "0") {
                        $('#imgUploadDiv2').hide();
                        $("#softwareSizeDiv").hide();
                        $('#softwareHrefDiv').show();
                    }
                }
            } else {
                $('#isAgencyDiv').hide();
                if (isOnline == "1") { // 非在线
                    $("#softwareSizeDiv").show();
                    $('#imgUploadDiv2').show();
                    $('#softwareHrefDiv').hide();
                    $('#validFile').val("notValidFile");
                } else {
                    $("#softwareSizeDiv").hide();
                    $('#imgUploadDiv2').hide();
                    $('#softwareHrefDiv').show();
                    $('#validFile').val("isValidFile");
                }
            }
        }

        $(function () {
            getSelectTopic();
            getPayType();
            setFileComponent();
            var uploadPicsUrl = "o_swfPicsUpload.jspx";
            var uploadAttachsUrl = "o_swfAttachsUpload.jspx";
            //在firefox、chrome下，上传不能保留登录信息，所以必须加上jsessionid。
            var jsessionid = "${sessionId!}";
            if (jsessionid) {
                uploadPicsUrl += ";jsessionid=" + jsessionid;
                uploadAttachsUrl += ";jsessionid=" + jsessionid;
            }
            swfu = new SWFUpload({
                upload_url: uploadPicsUrl,
                flash_url: "${base}/thirdparty/swfupload/swfupload.swf",
                file_size_limit: "20 MB",
                file_types: "*.jpg;*.gif;*.png;*.bmp",
                file_types_description: "图片",
                file_queue_limit: 0,
                custom_settings: {
                    progressTarget: "fsUploadProgress",
                    cancelButtonId: "btnCancel"
                },
                debug: false,

                button_image_url: "${base}/thirdparty/swfupload/button_notext.png",
                button_placeholder_id: "spanButtonPlaceHolder",
                button_text: "<span class='btnText'>上传</span>",
                button_width: 84,
                button_height: 24,
                button_text_top_padding: 2,
                button_text_left_padding: 20,
                button_text_style: '.btnText{color:#666666;}',

                file_queued_handler: fileQueued,
                file_queue_error_handler: fileQueueError,
                file_dialog_complete_handler: fileDialogComplete,
                upload_progress_handler: uploadProgress,
                upload_error_handler: uploadError,
                upload_success_handler: uploadPicsSuccess,
                upload_complete_handler: uploadComplete,
                queue_complete_handler: queueComplete
            });
            swfau = new SWFUpload({
                upload_url: uploadAttachsUrl,
                flash_url: "${base}/thirdparty/swfupload/swfupload.swf",
                file_size_limit: "2000 MB",
                file_types: "*.*",
                file_types_description: "All Types",
                file_queue_limit: 0,
                custom_settings: {
                    progressTarget: "afsUploadProgress",
                    cancelButtonId: "abtnCancel"
                },
                debug: false,

                button_image_url: "${base}/thirdparty/swfupload/button_notext.png",
                button_placeholder_id: "aspanButtonPlaceHolder",
                button_text: "<span class='btnText'>上传</span>",
                button_width: 84,
                button_height: 24,
                button_text_top_padding: 2,
                button_text_left_padding: 20,
                button_text_style: '.btnText{color:#666666;}',

                file_queued_handler: fileQueued,
                file_queue_error_handler: fileQueueError,
                file_dialog_complete_handler: fileDialogComplete,
                upload_progress_handler: uploadProgress,
                upload_error_handler: uploadError,
                upload_success_handler: uploadAttachSuccess,
                upload_complete_handler: uploadComplete,
                queue_complete_handler: queueComplete
            });
        });

        function uploadPicsSuccess(file, data) {
            var jsonData = eval("(" + data + ")");//转换为json对象
            if (jsonData.error != null) {
                $.alert("[@s.m 'global.prompt'/]", jsonData.error);
            } else {
                addPicLine();
                var index = picIndex - 1;
                imgUrl = jsonData.imgUrl;
                $("#preImg" + index).attr("src", "" + imgUrl);
                var imgSrc = parent.document.getElementById("preImg" + index);
                if (!$(imgSrc).attr("noResize")) {
                    $(imgSrc).css("width", "auto");
                    $(imgSrc).css("height", "auto");
                }
                $("#uploadImgPath" + index).val(imgUrl);
            }
        }

        function uploadAttachSuccess(file, data) {
            var jsonData = eval("(" + data + ")");//转换为json对象
            if (jsonData.error != null) {
                $.alert("[@s.m 'global.prompt'/]", jsonData.error);
            } else {
                $('#softwareSize').attr("readonly","readonly"); // 禁止手动填写大小
                var fsize = getFileSizeByByte(file.size);
                $('#softwareSize').val(fsize); // 自动填写软件大小

                addAttachLine();
                var index = attachIndex - 1;
                var attachUrl = jsonData.attachUrl;
                var attachName = jsonData.attachName;
                $("#attachmentPaths" + index).val(attachUrl);
                $("#attachmentNames" + index).val(attachName);
            }
            removeProgress(); // 上传完毕去掉进度框
        }

        // 处理上传文件大小
        function getFileSizeByByte(fsize){
            if (fsize > 1024) { // 初始为B
                fsize = fsize / 1024 ; // 转换为KB
                if (fsize > 1024) {
                    fsize = fsize / 1024 ; // 转换为MB
                    if (fsize > 1024) { // 转换为GB
                        fsize = Math.round(fsize * 100) / 100 / 1024;
                        fsize = fsize.toFixed(2);
                        fsize += "GB"
                    } else {
                        fsize = Math.round(fsize * 100) / 100;
                        fsize += "MB"
                    }
                } else {
                    fsize = Math.round(fsize * 100) / 100;
                    fsize += "KB";
                }
            } else {
                fsize += "B";
            }
            return fsize;
        }

        function removeProgress(){
            var index = $('#attachTable tr:last').attr('id').substr(8) - 1;
            $('#SWFUpload_1_' + index).remove();
        }
    </script>
    [#include "image_upload.html" /]
    [#include "attachment_upload.html" /]
    <style>
        .SDemandObj_input {
            line-height: 2em;
            height: 2em;
            text-align: center;
            margin: 5px;
            border: none
        }

        .SDemandObj_table {
            width: 90%;
            margin: auto;
            text-align: center;
            margin-top: 20px;
            line-height: 3em;
        }
    </style>
    <style type="text/css">
        .wrapper {
            width: 95%;
        }
    </style>
</head>
<body>
<div class="content wrapper">
    <form id="release_form" action="software_update.jspx?nextUrl=software_list.jspx" method="post">
        <div class="servicePower">
            <div class="column wrapper"><span class="head">软件基本信息</span> <span class="tips"><i>*</i>&nbsp;为必填项</span>
            </div>
            <div class="service-content wrapper">
                <div class="inputs">
                    <label><i>*</i>&nbsp;公司名称：</label>
                    <input class="power" id="companyName" name="companyName" type="text"
                           value="${software.companyName?default('')}" required maxlength="50">
                </div>
                <div class="inputs">
                    <label><i>*</i>&nbsp;软件分类：</label>
                    <select class="power" id="softwareType" name="softwareType">
                        <option value="制造工程师">制造工程师</option>
                        <option value="图文档">图文档</option>
                        <option value="实体设计">实体设计</option>
                        <option value="工艺图表">工艺图表</option>
                        <option value="数控车">数控车</option>
                        <option value="电子图版">电子图版</option>
                        <option value="线切割">线切割</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="inputs">
                    <label><i>*</i>&nbsp;付费类型：</label>
                    <select class="power" id="payType" name="payType">
                        <option value="付费">付费</option>
                        <option value="免费">免费</option>
                        <option value="租赁">租赁</option>
                    </select>
                </div>
                <div class="inputs" id="isAgencyDiv">
                    <label><i>*</i>&nbsp;是否平台代理：</label>
                    <input type="radio" id="isAgency0" name="isAgency" value="1" [#if software.agencyFlag=="1"] checked="checked" [/#if]
                           onchange="isAgencySelect(this)" required>
                    是&nbsp;&nbsp;
                    <input type="radio" id="isAgency1" name="isAgency" value="0" [#if software.agencyFlag=="0"] checked="checked" [/#if]
                           onchange="isAgencySelect(this)" required>
                    否
                </div>
                <div class="inputs" id="priceDiv">
                    <label><i>*</i>&nbsp;软件价格(元)：</label>
                    <input class="power price" id="price" name="price" type="text"
                           value="${software.price?default(0)}" required maxlength="13">
                </div>
                <div class="inputs" Id="isOnlineDiv">
                    <label><i>*</i>&nbsp;是否在线应用：</label>
                    <input type="radio" name="isOnline" value="0" onchange="myFunction(this)" [#if
                           software.isOnline=="0"] checked="checked" required [/#if]>
                    是&nbsp;&nbsp;
                    <input type="radio" name="isOnline" value="1" onchange="myFunction(this)" [#if
                           software.isOnline=="1"] checked="checked" required [/#if]>
                    否
                </div>
                <div class="inputs">
                    <label><i>*</i>&nbsp;软件名称：</label>
                    <input class="power space" id="softwareName" name="softwareName" type="text"
                           value="${software.softwareName?default('')}" required maxlength="50">
                </div>
                <div class="inputs" id="softwareSizeDiv">
                    <label><i>*</i>&nbsp;软件大小：</label>
                    <input class="power space" id="softwareSize" name="softwareSize" type="text"
                           value="${software.softwareSize?default('')}" required maxlength="20">
                </div>
                <div class="inputs" id="softwareHrefDiv">
                    <label><i>*</i>&nbsp;链接地址：</label>
                    <input class="power" id="softwareHref" name="softwareHref" type="text"
                           value="${software.softwareHref?default('')}" required maxlength="128">
                </div>
                <!--附件上传div-->
                <div class="uploadImgs" id="imgUploadDiv2">
                    <label><i>*</i>&nbsp;上传附件：</label><span style="color: red" id="pictureSpan2"></span>
                    <span>(只能上传一个附件)</span>
                    <div class="upLoadDiv">
                        &nbsp;<span id="aspanButtonPlaceHolder"></span><br>
                        <span style="display: none;"><input class="cancel" id="abtnCancel" type="button" value="取消"
                                                            onclick="swfu.cancelQueue();" disabled="disabled"/></span>
                        <div id="afsUploadProgress"></div>
                        <table id="attachTable" border="0" class="fbgj-fj" style="margin-left: 0;">
                            [#list software.content.attachments as file]
                            <tr id="attachTr${file_index}">
                                <td align="center">附件名称：<input type="text" id="attachmentNames${file_index}"
                                                               name="attachmentNames" class="member-change"
                                                               style="width:200px;height:24px;"
                                                               value="${file.attachmentName}"/></td>
                                <td align="center" width="50"><a onclick="$('#attachTr${file_index}').remove();"
                                                                 href="javascript:void(0);" class="pn-opt">删除</a></td>
                                <td align="center"><input type="text" id="attachmentPaths${file_index}"
                                                          name="attachmentPaths" class="member-change"
                                                          style="width:130px;height:24px;display: none"
                                                          value="${file.attachmentPath}"/></td>
                                <td align="center">
                                <span id="afc${file_index}" style="position:relative;display:block;width:250px;">
                                <input type='text' id='attachmentText${file_index}' class="member-change"
                                       style="width:150px;height:24px;display: none"/>
                                <input class="browse" type='button' value='浏览'
                                       style="width:40px;height:24px;cursor:pointer;background:#3694d7;color:#fff;font-size:12px;cursor:pointer;display: none"/>
                                <input onchange="$('#attachmentText${file_index}').val(this.value)" size="19"
                                       type="file" name="attachmentFile" id="attachmentFile${file_index}"
                                       style="height:28px;width:200px;opacity:0;filter:alpha(opacity=0);position:absolute;left:0;top:0;display: none"/>
                                <input type="button" value="上传" onclick="uploadAttachment(${file_index});"
                                       style="width:40px;height:24px;cursor:pointer;background:#3694d7;color:#fff;font-size:12px;cursor:pointer;display: none"/>
                                </span>
                                    <input type="hidden" id="attachmentFilenames${file_index}"
                                           name="attachmentFilenames"/>
                                </td>
                            </tr>
                            [/#list]
                        </table>
                    </div>
                    <textarea id="attachTr" style="display:none">
                        <tr id="attachTr{0}">
                            <td align="center">附件名称：<input type="text" id="attachmentNames{0}" name="attachmentNames"
                                                           class="member-change" style="width:200px;height:24px;"/></td>
                            <td align="center" width="50"><a onclick="$('#attachTr{0}').remove();"
                                                             href="javascript:void(0);" class="pn-opt">删除</a></td>
                            <td align="center"><input type="text" id="attachmentPaths{0}" name="attachmentPaths"
                                                      class="member-change"
                                                      style="width:130px;height:24px;display: none"/></td>
                            <td align="center">
                                <span id="afc{0}" style="position:relative;display:block;width:250px;">
                                <input type='text' id='attachmentText{0}' class="member-change"
                                       style="width:150px;height:24px;display: none"/>
                                <input class="browse" type='button' value='浏览'
                                       style="width:40px;height:24px;cursor:pointer;background:#3694d7;color:#fff;font-size:12px;cursor:pointer;display: none"/>
                                <input onchange="$('#attachmentText{0}').val(this.value)" size="19" type="file"
                                       name="attachmentFile" id="attachmentFile{0}"
                                       style="height:28px;width:200px;opacity:0;filter:alpha(opacity=0);position:absolute;left:0;top:0;display: none"/>
                                <input type="button" value="上传" onclick="uploadAttachment({0});"
                                       style="width:40px;height:24px;cursor:pointer;background:#3694d7;color:#fff;font-size:12px;cursor:pointer;display: none"/>
                                </span>
                                <input type="hidden" id="attachmentFilenames{0}" name="attachmentFilenames"/>
                            </td>
                        </tr>
                    </textarea>
                    <script type="text/javascript">
                        var attachIndex =${software.content.attachments?size};
                        var attachTpl = $.format($("#attachTr").val());
                        function addAttachLine() {
                            $('#attachTable').append(attachTpl(attachIndex++));
                        }
                    </script>
                </div>
                <!--图片上传div-->
                <div class="uploadImgs" id="imgUploadDiv">
                    <label><i>*</i>&nbsp;上传图片：</label>
                    <span>(最多可添加5张图片，建议上传400*400像素的图片，单张大小不超过2M)</span><span style="color: red" id="pictureSpan"></span>
                    <div class="upLoadDiv">
                        &nbsp;<span id="spanButtonPlaceHolder"></span><br>
                        <span style="display: none;"><input class="cancel" id="btnCancel" type="button" value="取消"
                                                            onclick="swfu.cancelQueue();" disabled="disabled"/></span>
                        <div id="fsUploadProgress" style="display: none;"></div>
                    </div>
                    <div id="picWrapper" class="picWrapper clearfix">
                        [#list software.content.pictures as p]
                        <table id="picTable${p_index}" border="0" class="fbgj-tab">
                            <tr>
                                <td><img id="preImg${p_index}" src="${p.imgPath!}" alt="预览" noResize="true"
                                         style="width:110px;height:110px;background-color:#ccc;border:1px solid #333"/>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div style="margin-top:4px;"><input type="text" id="uploadImgPath${p_index}"
                                                                        name="picPaths" value="${p.imgPath}"
                                                                        style="width:170px;display: none;"/> <a
                                            href="javascript:void(0);"
                                            onclick="$('#picTable${p_index}').remove();clearSpan();"
                                            class="pn-opt">删除</a></div>
                                    <div>
								<span id="ufc${p_index}" style="position:relative">
								<input type='text' id='uploadFileText${p_index}' size="10"
                                       style="border:1px solid #c7c7c7;display: none;"/>
								<input onchange="$('#uploadFileText${p_index}').val(this.value)" size="10" type="file"
                                       id="uploadFile${p_index}" class="file-button"
                                       style="width:200px;display: none;"/>
								</span>
                                        <input type="button" value="上传" onclick="upload(${p_index});"
                                               class="upload-button" style="display: none;"/>
                                    </div>
                                    <div><textarea style="width:200px;height:60px;display: none;" name="picDescs"
                                                   maxlength="255">${p.description!}</textarea></div>
                                </td>
                            </tr>
                        </table>
                        [/#list]
                    </div>
                    <div id="picBefore" style="clear:both"></div>
                    <div id="picTable" style="display:none;">
                        <table id="picTable{0}" border="0" cellpadding="0" cellspacing="0" class="fbgj-tab">
                            <tr>
                                <td><img id="preImg{0}" alt="预览" noResize="true"
                                         style="width:110px;height:110px;background-color:#ccc;border:1px solid #c7c7c7;"/>
                                </td>
                            </tr>
                            <tr>
                                <td style="line-height:1;">
                                    <div style="margin-top:4px;"><input type="text" id="uploadImgPath{0}"
                                                                        name="picPaths" class="member-change"
                                                                        style="display:none;"/> <a
                                            href="javascript:void(0);" onclick="$('#picTable{0}').remove();clearSpan()"
                                            class="pn-opt">删除</a></div>
                                    <div>
                                        <span id="ufc{0}" style="position:relative;">
                                        <input type='text' id='uploadFileText{0}' size="10" class="member-change"
                                               style="width:115px;height:30px;display:none;"/>
                                        <input onchange="$('#uploadFileText{0}').val(this.value)" size="10" type="file"
                                               id="uploadFile{0}" style="width:72px;height:30px;display:none;"/>
                                        </span>
                                        <input type="button" value="重新上传" onclick="upload({0});"
                                               style="width:50px;height:30px;cursor:pointer;background:#3694d7;color:#fff;font-size:12px;display:none;"/>
                                    </div>
                                    <div><textarea
                                            style="width:300px;height:60px;margin-bottom:0;margin-top:10px;display:none;"
                                            name="picDescs" maxlength="255"></textarea></div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <script type="text/javascript">
                        var picIndex = ${software.content.pictures?size};
                        var picTpl = $.format($("#picTable").html());
                        function addPicLine() {
                            $("#picWrapper").append(picTpl(picIndex++));
                        }
                    </script>
                </div>
                <div class="myDiv">
                    <label><i>*</i>&nbsp;文字说明：</label>
                    <script class="myEditor" id="editor" name="detailDesc" type="text/plain"></script>
                </div>
            </div>
            <br>
            <span style="color: red;margin-left: 200px" id="detailSpan"></span>
        </div>
        <!--联系信息-->
        <div class="servicePower">
            <div class="column wrapper"> <span class="head">联系信息</span> <span class="tips"></span><button type="button" id="addContact" class="addBtn" style="width:130px;">新增联系人信息</button>  </div>
            <!--收货人信息 start-->
            <div class="ckt-item info">
                <div class="top-ckt">
                    <span class="span-title-top">注：选中某条联系信息，该条联系信息设置为发布软件的联系信息</span>
                    <div class="clearfix"></div>
                </div>

                <!--地址列表-->
                <div class="center-ckt-info">
                    <ul id="address_list">
                        <!--通过load方法加载-->
                        <script type="text/javascript">
                            $(function(){
                                //  初始化收货人地址列表
                                //Ckt.info.i_InfoInitAddress();
                            });
                        </script>
                    </ul>
                    <!--报价隐藏div-->
                    <div class="window" id="bjWindow" hidden>
                        <div class="yxmain">
                            <div class="tableDiv tale">
                                <table border="0" class="wrapper" cellpadding="0" cellspacing="0" id="bjTable">
                                    <!--<thead>-->
                                    <!--<tr>-->
                                    <!--<th>地址标签</th>-->
                                    <!--<th>姓名</th>-->
                                    <!--<th>地址</th>-->
                                    <!--<th>电话</th>-->
                                    <!--<th>是否为默认地址</th>-->
                                    <!--</tr>-->
                                    <!--</thead>-->
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!--地址列表 end-->
                <div class="collapse-ckt-info">
                    <span class="more-collapse-ckt">更多地址</span>
                    <i class="icon-collapse-ckt-info"></i>
                </div>
                <div class="placeholder-20"></div>
            </div>
        </div>
        <div class="message">
            <p>优质的信息更能得到买家的青睐，以下方面建议您发布前可以再检查一下：</p>
            <p>1、选择准确的类目；</p>
            <p>2、软件标题中包含软件的优质信息，并突出软件卖点；</p>
            <p>3、尽可能地完善软件属性及软件信息详情，必要时软件详情可图文并茂；注意突出软件的优势及特点；</p>
            <p>4、上传清晰的软件图片。</p>
        </div>
        <div class="release-button">
            <button type="button" class="btn" onclick="beforeSubmit()">修改</button>
            <button type="button" class="btn cancel" onclick="returnList()">返回</button>
        </div>
        <input type="hidden" name="channelId" value="119">
        <input type="hidden" id="modelId" name="modelId" value="4">
        <input type="hidden" id="id" name="id" value="${software.softwareId}">
        <input type="hidden" id="validFile" name="validFile" value="isValidFile">
        <!--联系信息-->
        <div hidden>
            <input id="contact" name="contact" type="text" value="">
            <input id="mobile" name="mobile" type="text" value="">
            <input id="fax" name="fax" type="text" value="">
            <input id="email" name="email" type="text" value="">
            <input id="addrProvince" name="addrProvince" type="text" value="">
            <input id="addrCity" name="addrCity" type="text" value="">
            <input id="addrCounty" name="addrCounty" type="text" value="">
            <input id="addrStreet" name="addrStreet" type="text" value="">
            <input id="postCode" name="postCode" type="text" value="">
        </div>
    </form>
</div>

<script type="text/javascript" charset="utf-8" src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script type="text/javascript" charset="utf-8" src="${base}/thirdparty/ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="${base}/thirdparty/ueditor/ueditor.all.js"></script>
<script charset="utf-8" src="/${res}/resources/js/mapDistPicker/distpicker.data.js" type="text/javascript"></script>
<script charset="utf-8" src="/${res}/resources/js/mapDistPicker/distpicker.js" type="text/javascript"></script>
<!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
<!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
<script type="text/javascript" charset="utf-8" src="${base}/thirdparty/ueditor/lang/zh-cn/zh-cn.js"></script>
<script type="text/javascript" charset="utf-8" src="/${res}/resources/js/breakingNews.js"></script>
<script type="text/javascript">
    var editor = UE.getEditor('editor',{autoHeightEnabled:false,zIndex:0});
</script>
<script language="javascript">
    UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
    UE.Editor.prototype.getActionUrl = function(action) {
        if (action == 'uploadimage' || action == 'uploadscrawl' || action == 'uploadimage') {
            return "/ueditor/upload.jspx";
        } else {
            return this._bkGetActionUrl.call(this, action);
        }
    }
</script>
<script type="text/javascript">
    $(document).ready(function () {
//        $("#editor").html('${software.content.txt!?default("")}');
        editor.ready(function () {
            editor.setContent('${software.content.txt!?default("")}');
        });
    })
</script>
<!--Gao JN添加的js-->
<script>
    function beforeSubmit() {
        var result = checkPicture();
        var result1 = checkEdit();
        var isOnline = "${software.isOnline!}";
        var payType = "${software.payType!}";
        var isAgency = "${software.agencyFlag!}";
        if (((isOnline == "0") && (payType == "免费")) || ((payType == "付费") && (isAgency == "0")) || ((payType == "付费") && (isAgency == "1") && (isOnline == "0")) || ((payType == "租赁") && (isAgency == "1") && (isOnline == "0")) || ((payType == "租赁") && (isAgency == "0"))) {
            result2 = true;
        } else {
            result2 = checkFile();
        }
        var result3 = checkFileNum();
        var obj = $("#bjTable tbody").find(".infoSelected");
        fillContactInfo(obj); // 塞入联系信息
        var obj = $("#bjTable tbody").find(".infoSelected");
        if (obj != undefined) {
            if (obj.length != 0) {
                window.isDef += 1;
            }
        }
        fillContactInfo(obj); // 塞入联系信息
        var result4 = checkContact(); // 联系人非空检验
        if (validform().form()) {
            if (result && result1 && result2 && result3) {
                if (result4 == false) {
                    ui.alertFail("请在本页面底部【新增联系人信息】");
                    return false;
                }
                if (window.isDef < 1) {
                    ui.alertFail("请在本页面底部选择发布软件的联系人信息");
                    return false;
                }
                var typestr = "是否修改？";
                if (confirm("请确认" + typestr + "")) {
                    $('#release_form').submit();
                }
            }
        }
    }

    $(document).ready(function (e) {
        var SObjTr = $('#originTr').prop('outerHTML');
        $('#tianjiaSObj').click(function () {
            $('#SDemandObj_table').append(SObjTr);
        });
        $('.autoInput').click(function () {
            if ($(this).is(':checked')) {
                $(this).prevAll('input').eq(0).val($(this).next('span.special').text()).attr("readonly", "readonly");
                $(this).prevAll('input').eq(0).focus().blur();
            } else {
                $(this).prevAll('input').eq(0).val("").removeAttr("readonly");
                $(this).prevAll('input').eq(0).focus().blur();
            }
    });

        // 根据下拉框的 免费/付费/租赁 更改表单
        $('#payType').change(function () {
            var type = $(this).val();
            if (type == "免费") {
                $('#imgUploadDiv2').show();
                $('#softwareSize').attr("readonly", "readonly");
                $('#priceDiv').hide();
                $('#price').attr("readonly", "readonly").val("0");
                $('#isAgencyDiv').hide();
            } else if (type == "付费") {
                $('#imgUploadDiv2').find('.pn-opt').click();
//               $('#imgUploadDiv2').hide();
                $('#priceDiv').show();
                $('#softwareSize').removeAttr("readonly").val("");
                $('#price').removeAttr("readonly").val("");
                $('#isAgencyDiv').show();
            } else if (type == "租赁") {
                $('#imgUploadDiv2').find('.pn-opt').click();
//               $('#imgUploadDiv2').hide();
                $('#priceDiv').show();
                $('#softwareSize').removeAttr("readonly").val("");
                $('#price').removeAttr("readonly").val("");
                $('#isAgencyDiv').show();
            }
        });
    });

    function returnList() {
        location.href = "software_list.jspx";
    }

    ;
    /**
     * 图片校验
     *
     */
    function checkPicture() {
        if ($("#imgUploadDiv").find('img').size() < 2) {
            $("#pictureSpan").html("未上传图片！请检查.");
            return false;
        }
        if ($("#imgUploadDiv").find('img').size() > 6) {
            $("#pictureSpan").html("最多上传5张图片！请检查");
            return false;
        }
        return true;
    }

    function checkFile() {
        if (($("#imgUploadDiv2").find('input').size() < 2)  && ($('#validFile').val() == "isValidFile")) {
            $("#pictureSpan2").html("未上传附件！请检查.");
            return false;
        }
        return true;
    }

    function checkFileNum() {
        if (($("#imgUploadDiv2").find('input').size() > 14)  && ($('#validFile').val() == "isValidFile")) {
            $("#pictureSpan2").html("只能上传一个附件！请检查.");
            return false;
        }
        return true;
    }

    //富文本校验
    function checkEdit() {
        var length = editor.getContentLength();
        var maxWord = editor.getOpt("maximumWords") || 400000;
        if (length <= 0) {
            $("#detailSpan").html("文字说明未填写！请检查");
            return false;
        }
        if (length > maxWord) {
            $("#detailSpan").html("文字说明文字过多");
            return false;
        }
        return true;
    }

    $(document).ready(function () {
        //把没有图片上传的提示语删掉
        $("#imgUploadDiv").mouseleave(function () {
            if ($("#imgUploadDiv").find('img').size() > 1 && $("#imgUploadDiv").find('img').size() < 7) {
                $("#pictureSpan").html("");
            }
        });
        //把没有附件上传的提示语删掉
        $("#imgUploadDiv2").mouseleave(function () {
            if ($("#imgUploadDiv2").find('input').size() > 1) {
                $("#pictureSpan2").html("");
            }
        });
        //把没有文本编辑的提示语删掉
        editor.addListener("focus", function (type, event) {
            $("#detailSpan").html("");
        });
        if (self.frameElement != null && self.frameElement.tagName == "IFRAME") {
            // 在iframe中时处理
            $(".wrapper").css("width", "95%");
        }
    });

    function clearSpan() {
        if ($("#imgUploadDiv").find('img').size() > 1 && $("#imgUploadDiv").find('img').size() < 7) {
            $("#pictureSpan").html("");
            return false;
        }
        return true;
    }

    // 是否平台代理
    function isAgencySelect(obj) {
        var isAgency = obj.value;
        if (isAgency == "1") { // 平台代理
//            $('#imgUploadDiv2').hide();
//            $('#validFile').val("notValidFile");
            $('#isOnlineDiv').show();
            $("#softwareSizeDiv").show();
            $('#softwareHrefDiv').hide();
            if ($('#isOnlineDiv').find(":selected").val() == "1") { // 平台代理非在线应用
                $('#imgUploadDiv2').show();
                $('#softwareHrefDiv').hide();
                $('#validFile').val("isValidFile");
            } else if ($('#isOnlineDiv').find(":selected").val() == "0") {
                $('#imgUploadDiv2').hide();
                $('#softwareHrefDiv').show();
                $('#validFile').val("notValidFile");
            }
        } else {
            $('#isOnlineDiv').hide();
            $("#softwareSizeDiv").hide();
            $('#softwareHrefDiv').show();
        }
    }

    // 根据是否在线应用选择状态
    function myFunction(obj) {
        var isOnline;
        if (obj == "onload") {
            isOnline = undefined;
        } else {
            isOnline = obj.value;
        }
        if ((isOnline == "0")) {
            $("#softwareSizeDiv").hide();
            $('#imgUploadDiv2').find('.pn-opt').click();
            $('#imgUploadDiv2').hide();
            $('#validFile').val("notValidFile");
            $('#softwareHrefDiv').show();
        } else {
            $("#softwareSizeDiv").show();
            $('#imgUploadDiv2').show();
            $('#validFile').val("isValidFile");
            $('#softwareHrefDiv').hide();
        }
    }

    //  新增联系人信息
    $('#addContact').on('click', function(){
        openContactAdd();
    });

    // 打开联系人新增页面
    function openContactAdd () {
        layer.open({
            type: 2,
            title: ['联系人信息', 'background-color: #318CB8;text-align:center;font-size:18px;'],
            shadeClose: true,
            shade: false,
            maxmin: true,
            area: ['800px', '490px'],
            content: '/member/getContactAddrAdd.jspx',
            end: function(){
                // 如果是通过单击关闭按钮关闭弹出层，父画面没有此表单
                if($("#popupForm").length === 1){
                    $("#popupForm").submit();
                }
            }
        });
    }

    // 设置联系信息为发布软件联系信息
    function infoSelected (obj) {
        layer.confirm('确定该条联系信息设为发布软件的联系信息？', {
                    skin: 'layui-layer-lan',
                    icon: 3,
                    shift: -1,
                    btn: ['确定', '取消'] //可以无限个按钮
                },
                function (index, layero) {
                    // 塞入联系信息
                    fillContactInfo(obj);
                    layer.close(index);
                    $(obj).siblings().removeClass("infoSelected");
                    $(obj).addClass("infoSelected");
                    $(obj).siblings().find("#shipAddressName").removeClass("ckt-checkbox selected");
                    $(obj).find("#shipAddressName").addClass("ckt-checkbox selected");
                    window.isDef += 1;
                }, function (index) {
                    layer.close(index);
                    return false;
                });
    }

    // 检验联系人信息非空
    function checkContact() {
        var isCheck = ($("#contact").val() != "") && ($("#contact").val() != null) && ($("#contact").val() != undefined);
        return isCheck;
    }

    // 塞入联系信息
    function fillContactInfo (obj) {
        if ($("#userName1")[0] != undefined) {
            if ($(obj).length != 0) {
                if (($(obj).find("#userName1")[0].innerText != "") && ($(obj).find("#userName1")[0].innerText != null) && ($(obj).find("#userName1")[0].innerText != undefined)) {
                    $("#contact").val($(obj).find("#userName1")[0].innerText);
                    $("#mobile").val($(obj).find("#mobile1")[0].innerText);
                    $("#postCode").val($(obj).find("#postCode1")[0].innerText);
                    if ($("#fax1")[0].innerText == 'undefined') {
                        $("#fax").val("");
                    } else {
                        $("#fax").val($(obj).find("#fax1")[0].innerText);
                    }
                    if ($("#email1")[0].innerText == 'undefined') {
                        $("#email").val("");
                    } else {
                        $("#email").val($(obj).find("#email1")[0].innerText);
                    }
                    $("#addrProvince").val($(obj).find("#addrProvince1")[0].innerText);
                    $("#addrCity").val($(obj).find("#addrCity1")[0].innerText);
                    $("#addrCounty").val($(obj).find("#addrCounty1")[0].innerText);
                    $("#addrStreet").val($(obj).find("#addrStreet1")[0].innerText);
                }
            } else {
                $("#contact").val($("#userName1")[0].innerText);
                $("#mobile").val($("#mobile1")[0].innerText);
                $("#postCode").val($("#postCode1")[0].innerText);
                if ($("#fax1")[0].innerText == 'undefined') {
                    $("#fax").val("");
                } else {
                    $("#fax").val($("#fax1")[0].innerText);
                }
                if ($("#email1")[0].innerText == 'undefined') {
                    $("#email").val("");
                } else {
                    $("#email").val($("#email1")[0].innerText);
                }
                $("#addrProvince").val($("#addrProvince1")[0].innerText);
                $("#addrCity").val($("#addrCity1")[0].innerText);
                $("#addrCounty").val($("#addrCounty1")[0].innerText);
                $("#addrStreet").val($("#addrStreet1")[0].innerText);
            }
        }
    }
</script>
</body>
</html>